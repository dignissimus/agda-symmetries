\section{Construction of Free Commutative Monoids}
\label{sec:commutative-monoids}

We now extend our constructions of free monoids to free commutative monoids.

\subsection{Swap-List}
We can use HITs where adjacent swaps generate all symmetries,
for example swap-list taken from \cite{Choudhury_2023}, where they have
also given a proof of its universal property.

\begin{code}
data SList (A : UU) : UU where
  nil : SList A
  _cons_ : A -> SList A -> SList A
  swap : forall x y xs -> x :: y :: xs == y :: x :: xs 
  trunc : forall x y -> (p q : x == y) -> p == q
\end{code}

\vc{Explain trunc, why SList does but List doesn't? They both form endofunctors on $\Set$.}

\subsection{Free monoid quotiented with permutation}
We give a general construction of free commutative monoid as a free monoid quotient.
Specific instances of this construction are given in \ref{cmon:plist} and \ref{cmon:bag}.
If $(F, \mu)$ satisfies the universal property of free monoid,
then $(F(A), i, \otimes)$ quotiented by a permutation relation $(F(A) / \approx, e, \doubleplus)$
would be a free commutative monoid on $A$.

A relation $\approx$ is a correct permutation relation iff it:
\begin{itemize}
    \item is reflexive, symmetric, transitive (equivalence),
    \item is a congruence wrt $\otimes$: $a \otimes b \to c \otimes d \to a \otimes c \approx b \otimes d$,
    \item is commutative: $a \otimes b \approx b \otimes a$, and
    \item respects $\ext{(\blank)}$: $\forall f. \, a \approx b \to \ext{f}(a) = \ext{f}(b)$.
\end{itemize}

Let $q : F(A) \to F(A) / \approx$ by the quotient map.
The generator map $\eta_A$ is given by $q \comp \mu$, and the identity element is $q(i)$.

\begin{proposition}
$(F(A) / \approx, \doubleplus, q(i))$ is a commutative monoid.
\end{proposition}

\begin{proof}
Since $\approx$ is congruence wrt $\otimes$,
we can lift $\otimes : F(A) \to F(A) \to F(A)$ to the quotient to obtain
$\doubleplus : F(A) / \approx \to F(A) / \approx \to F(A) / \approx$.
$\doubleplus$ would also satisfy the unit laws and associativity law which $\otimes$ satisfy.
Commutativity of $\doubleplus$ follows from the commutativity requirement of $\approx$,
therefore $(F(A) / \approx, \doubleplus, q(i))$ forms a commutative monoid.
\end{proof}

For clarity, we will use $\hat{(\blank)}$ to denote the extension operation of $F(A)$, 
and $\ext{(\blank)}$ for the extension operation of $F(A) / \approx$.

\begin{definition}
We define the $\ext{(\blank)}$ on $f : A \to X$ to $\ext{f} : F(A) / \approx \to \mathfrak{X}$ as follow:
we first obtain $\hat{f} : F(A) \to \mathfrak{X}$ by universal property of $F$, and lift it
to $F(A) / \approx \to \mathfrak{X}$, which is allowed since $\approx$ respects $\ext{(\blank)}$.
\end{definition}

\begin{proposition}
    For all $f : A \to X$, $x : F(A)$, $\ext{f}(q(x))$ reduces to $\hat{f}(x)$.
\end{proposition}

\begin{proposition}[Universal property for $F(A) / \approx$]
    $(F(A) / \approx,\eta_A)$ is the free commutative monoid on $A$.
\end{proposition}

\begin{proof}
    To show that $\ext{(\blank)}$ is an inverse to $\blank \comp \eta_A$,
    we first show $\ext{(\blank)}$ is the right inverse to $\blank \comp \eta_A$.
    For all $f$ and $x$, $(\ext{f} \comp \eta_A)(x) = (\ext{f} \comp q)(\mu_A(x)) = \hat{f}(\mu_A(x))$.
    By universal property of $F$, $\hat{f}(\mu_A(x)) = f(x)$, therefore $(\ext{f} \comp \eta_A)(x) = f(x)$.
    By function extensionality, for any $f$, $\ext{f} \circ \eta_A = f$,
    and $(\blank \circ \eta_A) \comp \ext{(\blank)} = id$.

    To show $\ext{(\blank)}$ is the left inverse to $\blank \comp \eta_A$, we need to prove
    for any commutative monoid homomorphism $f : F(A) / \approx \to \mathfrak{X}$ and $x : F(A) / \approx$,
    $\ext{(f \comp \eta_A)}(x) = f(x)$. To prove this it is suffice to show for all $x : F(A)$,
    $\ext{(f \comp \eta_A)}(q(x)) = f(q(x))$. 
    $\ext{(f \comp \eta_A)}(q(x))$ reduces to $\widehat{(f \comp q \comp \mu_A)}(x)$.
    Note that both $f$ and $q$ are homomorphism, therefore $f \comp q$ is a homomorphism. By
    universal property of $F$ we get $\widehat{(f \comp q \comp \mu_A)}(x) = (f \comp q)(x)$,
    therefore $\ext{(f \comp \eta_A)}(q(x)) = f(q(x))$.

    We have now shown that $(\blank) \comp \eta_A$ is an equivalence from
    commutative monoid homomorphisms $F(A) / \approx \to \mathfrak{X}$
    to set functions $A \to X$, and its inverse is given by $\ext{(\blank)}$, which maps set
    functions $A \to X$ to commutative monoid homomorphisms $F(A) / \approx \to \mathfrak{X}$.
    Therefore, $F(A) / \approx$ is indeed a free commutative monoid on $A$.
\end{proof}


\subsection{List quotiented with permutation}\label{cmon:plist}
A specific instance of this construction would be List quotiented with permutation to get commutativity.
This construction is taken from \cite{joram_et_al:LIPIcs.ITP.2023.20}, who gave a proof on how
$\term{PList}$ is isomorphic to free commutative monoid as a HIT. We give a direct proof of its universal
property instead.

\begin{lstlisting}
PList : Type -> Type
PList A = Array A / Perm
\end{lstlisting}

\subsection{Bag}\label{cmon:bag}
Alternatively, we can also quotient Array with symmetries to get commutativity.
This construction is taken from \cite{Choudhury_2023}. \cite{joram_et_al:LIPIcs.ITP.2023.20}
also gave a similar construction, where only the index function is quotiented, instead of
the entire array. Both proved $\term{Bag}$ is a free commutative monoid by isomorphism to
other constructions. We give a direct proof of its universal property instead.

\begin{lstlisting}
_$\approx$_ : Array A $\to$ Array A $\to$ Type
(n , f) $\approx$ (m , g) = $\Sigma$[ $\sigma$ $\in$ Iso (Fin n) (Fin m) ] v $\equiv$ w $\circ$ $\sigma$ .fun

Bag : Type -> Type
Bag A = Array A / _$\approx$_
\end{lstlisting}

How to show $\approx$ respects commutativity: $a \otimes b \approx b \otimes a$?

Let $a = (n , f)$ and $b = (m , g)$, we need to compute an isomorphism $\phi\colon \Fin[n+m]\xto{\sim}\Fin[m+n]$,
such that: $(f \oplus g) = (g \oplus f) \circ \phi$.

We can use combinators from formal operations in symmetric rig groupoids \cite{10.1145/3498667} to define $\phi$:
\begin{align*}
    \phi := \Fin[n+m] \xto{\sim} \Fin[n] + \Fin[m] \xto{\term{swap}_{+}} \Fin[m] + \Fin[n] \xto{\sim} \Fin[m+n] \\
\end{align*}

\begin{figure}[H]
    \centering
    \vspace{-1em}
      % https://q.uiver.app/#q=WzAsMixbMCwwLCJcXHswLDEsXFxkb3RzLG4tMSwgbixuKzEsXFxkb3RzLG4rbS0xXFx9Il0sWzAsMSwiIFxce24sbisxXFxkb3RzLG4rbS0xLDAsMSxcXGRvdHMsbi0xXFx9Il0sWzAsMSwiIiwwLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoibWFwcyB0byJ9fX1dXQ==
\begin{tikzcd}[ampersand replacement=\&,cramped]
	{\{\color{red}0,1,\dots,n-1, \color{blue} n,n+1,\dots,n+m-1 \color{black}\}} \\
	{ \{\color{blue}n,n+1\dots,n+m-1, \color{red}0,1,\dots,n-1 \color{black}\}}
    \arrow["\phi", maps to, from=1-1, to=2-1]
\end{tikzcd}
    \caption{Operation of $\phi$}
    \label{fig:enter-label}
\end{figure}

To show $\approx$ respects $\ext{(\blank)}$: $\forall f. \, a \approx b \to \ext{f}(a) = \ext{f}(b)$,
we need to prove $\ext{f}$ is invariant under permutation: for all $\phi\colon \Fin[n]\xto{\sim}\Fin[n]$,
$\ext{f}(n, i) \id \ext{f}(n, i \circ \phi)$.

\begin{lemma}
Given $\phi\colon \Fin[S(n)]\xto{\sim}\Fin[S(n)]$, there is a $\tau\colon \Fin[S(n)]\xto{\sim}\Fin[S(n)]$
such that $\tau(0) = 0$, and $\ext{f}(S(n), i \circ \phi) = \ext{f}(S(n), i \circ \tau)$.
\end{lemma}

Let $k$ be $\phi^{-1}(0)$, and $k + j = S(n)$:
\begin{align*}
    \tau := \Fin[S(n)] \xto{\phi} \Fin[S(n)] \xto{\sim} \Fin[k+j] \xto{\sim} \Fin[k] + \Fin[j]
    \xto{\term{swap}_{+}} \Fin[j] + \Fin[k] \xto{\sim} \Fin[j+k] \xto{\sim} \Fin[S(n)]
\end{align*}

\begin{figure}[H]
    \centering
    \begin{tikzcd}[ampersand replacement=\&,cramped]
    	{\{\color{blue}0, 1, 2, \dots, \color{red}k, k+1, k+2, \dots \color{black}\}} \\
    	{ \{\color{blue}x, y, z, \dots, \color{red}0, u, v, \dots \color{black}\}}
        \arrow["\phi", maps to, from=1-1, to=2-1]
    \end{tikzcd}
    \hspace{1em}
    \begin{tikzcd}[ampersand replacement=\&,cramped]
    	{\{\color{blue}0, 1, 2, \dots, \color{red}k, k+1, k+2, \dots \color{black}\}} \\
    	{ \{\color{red}0, u, v, \dots, \color{blue}x, y, z, \dots \color{black}\}}
        \arrow["\tau", maps to, from=1-1, to=2-1]
    \end{tikzcd}
    \caption{Operation of $\tau$ constructed from $\phi$}
    \label{fig:enter-label}
\end{figure}

\begin{lemma}
Given $\tau\colon \Fin[S(n)]\xto{\sim}\Fin[S(n)]$ where $\tau(0) = 0$,
there is a $\psi : \Fin[n] \xto{\sim} \Fin[n]$ such that $\tau \circ S = S \circ \psi$.
\end{lemma}

\begin{figure}[H]
    \centering
    \begin{tikzcd}[ampersand replacement=\&,cramped]
    	{\{\color{blue}0, \color{red}1, 2, 3, \dots \color{black}\}} \\
    	{ \{\color{blue}0, \color{red} x, y, z \dots \color{black}\}}
        \arrow["\tau", maps to, from=1-1, to=2-1]
    \end{tikzcd}
    \hspace{1em}
    \begin{tikzcd}[ampersand replacement=\&,cramped]
    	{\{\color{red}0, 1, 2, \dots \color{black}\}} \\
    	{ \{\color{red} x-1, y-1, z-1 \dots \color{black}\}}
        \arrow["\psi", maps to, from=1-1, to=2-1]
    \end{tikzcd}
    \caption{Operation of $\psi$ constructed from $\tau$}
    \label{fig:enter-label}
\end{figure}

\begin{theorem}
For all $\phi\colon \Fin[n]\xto{\sim}\Fin[n]$, $\ext{f}(n, i) \id \ext{f}(n, i \circ \phi)$.
\end{theorem}

\begin{itemize}
    \item On $n = 0$, $\ext{f}(n, i) \id \ext{f}(n, i \circ \phi) = e$.
    \item On $n = S(m)$,
        \begin{align*}
        & \ext{f}(S(m), i \circ \phi) \\
        & = \ext{f}(S(m), i \circ \tau) \\
        & = f(i(\tau(0))) \otimes \ext{f}(m, i \circ \tau \circ S) & \text{(by definition)} \\
        & = f(i(0)) \otimes \ext{f}(m, i \circ \tau \circ S) & \text{(by property of $\tau$)} \\
        & = f(i(0)) \otimes \ext{f}(m, i \circ S \circ \psi) \\
        & = f(i(0)) \otimes \ext{f}(m, i \circ S) & \text{(induction)} \\
        & = \ext{f}(S(m), i)
        \end{align*}
\end{itemize}

